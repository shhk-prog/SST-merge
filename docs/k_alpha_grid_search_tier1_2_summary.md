# k-alphaグリッドサーチ Tier 1 & 2 結果まとめ

## 実験概要

- **モデル**: Llama-3.1-8B-Instruct
- **バリアント**: A5+A7 (RepliQA + Safety)
- **FIMサンプル数**: 500
- **実行期間**: 2025-12-26 05:15 - 12:09 (約7時間)

## Tier 1: 粗探索 (8組合せ)

**目的**: 広範囲のk値とα値の組み合わせを探索

### 実行結果

| k | α | マージ | 評価 | 備考 |
|---|---|--------|------|------|
| 20 | 0.7 | スキップ | スキップ | 既存 |
| 20 | 0.9 | ✓ | ✓ | 成功 |
| 30 | 0.9 | ✓ | ✓ | 成功 |
| 30 | 1.0 | スキップ | スキップ | 既存 |
| 50 | 0.8 | ✓ | ✓ | 成功 |
| 50 | 0.9 | ✓ | ✓ | 成功 |
| 15 | 1.0 | ✓ | ✓ | 成功 |
| 10 | 1.0 | ✓ | ✓ | 成功 |

**サマリー**:
- 成功: 6/8 (75%)
- スキップ: 2/8 (25%, 既存結果あり)
- 失敗: 0/8

## Tier 2: 境界探索 (8組合せ)

**目的**: 極端な値や低α値の効果を検証

### 実行結果

| k | α | マージ | 評価 | 備考 |
|---|---|--------|------|------|
| 5 | 1.0 | ✓ | ✓ | 成功 (最小k) |
| 10 | 0.9 | ✓ | ✓ | 成功 |
| 15 | 0.9 | ✓ | ✓ | 成功 |
| 30 | 0.7 | ✓ | ✓ | 成功 |
| 50 | 0.7 | ✓ | ✓ | 成功 (最大k) |
| 20 | 0.5 | ✓ | ✓ | 成功 (最小α) |
| 30 | 0.5 | ✓ | ✓ | 成功 |
| 50 | 0.5 | ✓ | ✓ | 成功 |

**サマリー**:
- 成功: 8/8 (100%)
- スキップ: 0/8
- 失敗: 0/8

## 評価結果の詳細

aggregated_results.jsonから抽出したA5+A7の評価結果（一部のみ記録あり）：

### k=10, α=0.8
- **Jailbreak耐性**: 70.6%
- **BeaverTails拒否率**: 6.0%
- **MMLU正解率**: 54.0%
- **RepliQA ROUGE-L**: 0.324

### k=20, α=1.0
- **Jailbreak耐性**: 77.6% ⭐ (最高)
- **BeaverTails拒否率**: 2.0%
- **MMLU正解率**: 52.9%
- **RepliQA ROUGE-L**: 0.405 ⭐ (最高)

### k=3, α=1.0
- **Jailbreak耐性**: 75.8%
- **BeaverTails拒否率**: 2.0%
- **MMLU正解率**: 52.3%
- **RepliQA ROUGE-L**: 0.405

### k=5, α=0.5
- **Jailbreak耐性**: 57.4%
- **BeaverTails拒否率**: 11.8%
- **MMLU正解率**: 55.9% ⭐ (最高)
- **RepliQA ROUGE-L**: データなし

## 主要な発見

### 1. α値の影響

- **α=1.0**: 最高のJailbreak耐性（77.6%）とRepliQA性能（0.405）
- **α=0.5**: 最高のMMU正解率（55.9%）だが、Jailbreak耐性が低下（57.4%）
- **トレードオフ**: α値を下げるとUtility性能は向上するが、Safety性能が低下

### 2. k値の影響

- **k=20**: バランスの取れた性能（Jailbreak 77.6%, MMLU 52.9%）
- **k=5**: Utility重視の場合に有効（MMLU 55.9%）
- **k=3 vs k=20**: ほぼ同等のSafety性能だが、k=20の方がわずかに優れる

### 3. 最適な組み合わせ

**Safety重視**: k=20, α=1.0
- Jailbreak耐性: 77.6%
- RepliQA: 0.405
- MMLU: 52.9%

**Utility重視**: k=5, α=0.5
- MMLU: 55.9%
- Jailbreak耐性: 57.4%

**バランス型**: k=10, α=0.8
- Jailbreak耐性: 70.6%
- MMLU: 54.0%
- RepliQA: 0.324

## Tier 3: 詳細探索 (12組合せ)

**目的**: 固有値分析に基づく最適値周辺の詳細探索

### 実行結果

| k | α | マージ | 評価 | 備考 |
|---|---|--------|------|------|
| 22 | 0.9 | ✓ | ✓ | 成功 |
| 25 | 0.9 | ✓ | ✗ | 評価失敗 |
| 28-30 | 0.75-0.95 | ✗ | ✗ | 失敗（環境問題） |

**サマリー**:
- 成功: 1/12 (8%)
- 失敗: 11/12 (92%)
- **原因**: conda環境の問題（numpy, huggingface_hubモジュール欠如）

## 全体サマリー

### 成功率

- **Tier 1**: 6/8成功 (75%, 2スキップ)
- **Tier 2**: 8/8成功 (100%)
- **Tier 3**: 1/12成功 (8%, 環境問題)
- **合計**: 15/28成功 (54%)

### 実行時間

- **Tier 1**: 約2時間5分 (05:15 - 07:20)
- **Tier 2**: 約4時間48分 (07:20 - 12:09)
- **平均**: 1実験あたり約25分

### 探索されたパラメータ範囲

**k値**:
- 最小: 5
- 最大: 50
- 探索値: 5, 10, 15, 20, 22, 25, 28, 30, 50

**α値**:
- 最小: 0.5
- 最大: 1.0
- 探索値: 0.5, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.0

## 推奨事項

### 1. Tier 3の再実行

conda環境を有効化して再実行：

```bash
conda activate sst
python3 experiments/grid_search_k_alpha.py --tier 3 --skip_existing
```

### 2. 追加実験の提案

現在の結果から、以下の追加実験を推奨：

- **k=15-25, α=0.9-1.0**: 最適値の詳細探索
- **k=10, α=0.7-0.9**: バランス型の詳細探索

### 3. 評価結果の完全な収集

一部の実験（Tier 1 & 2の成功実験）で評価結果がaggregated_results.jsonに記録されていません。評価スクリプトを再実行して完全なデータを収集する必要があります。

## ファイル

- **実験結果**: `results/grid_search/grid_search_tier{1,2,3}_results.json`
- **評価結果**: `results/model_evaluation/llama-3.1-8b/sst-merge/aggregated_results.json`
- **応答ファイル**: `results/model_evaluation/llama-3.1-8b/sst-merge/responses_*.jsonl`
