# k=10 vs k=20 結果比較分析

## 評価結果サマリー

| メトリクス | k=10 | k=20 | 差分 | 目標 | 達成 |
|-----------|------|------|------|------|------|
| **Jailbreak** | 74.80% | **78.20%** | **+3.4%** ✅ | 77%+ | ✅ |
| **MMLU** | 49.60% | **50.60%** | **+1.0%** | 52%+ | ❌ |
| **RepliQA** | 34.04% | **34.10%** | **+0.06%** | 40%+ | ❌ |
| **Alpaca** | 35.95% | 34.77% | -1.18% | - | - |
| **Refusal Rate** | 3.00% | 2.20% | -0.8% | - | - |
| **Harmful Rate** | 0.80% | 0.80% | 0% | - | - |

---

## 重要な発見

### ✅ Jailbreak Resistanceが目標達成

**k=20: 78.20% > 77%（目標）**
- k=10から+3.4%の改善
- 元のSST-Merge (77.6%)を**上回る**
- **結論**: k=20でSafety目標を達成

### ❌ Utilityは依然として低い

**MMLU: 50.60% < 52%（目標）**
- A5単体 (52.7%)より-2.1%低い
- 元のSST-Merge (52.9%)より-2.3%低い

**RepliQA: 34.10% < 40%（目標）**
- A5単体 (40.2%)より-6.1%低い
- 元のSST-Merge (40.5%)より-6.4%低い
- **ほとんど改善していない**（k=10から+0.06%のみ）

---

## 問題点の分析

### 1. RepliQAが全く改善していない

**k=10 → k=20の変化**:
- Jailbreak: 74.80% → 78.20% (+3.4%)
- MMLU: 49.60% → 50.60% (+1.0%)
- RepliQA: 34.04% → 34.10% (+0.06%) ← **ほぼ変化なし**

**仮説**:
- RepliQAは長文生成タスク
- Safety Subspaceへの射影が生成能力を破壊している
- k値を増やしても改善しない

### 2. 元のSST-Mergeとの比較

| メトリクス | 元のSST (k=20) | 現在 (k=20) | 差分 |
|-----------|----------------|-------------|------|
| Jailbreak | 77.6% | 78.2% | **+0.6%** ✅ |
| MMLU | 52.9% | 50.6% | **-2.3%** ❌ |
| RepliQA | 40.5% | 34.1% | **-6.4%** ❌ |

**結論**: 
- Safetyは改善
- **Utilityが大幅に悪化**

### 3. 根本原因の推測

**可能性1: 射影の実装に問題がある**
- 理論: `safety_projected = V_k @ (V_k^T @ safety)`
- 実装: `_project_to_safety_subspace`メソッド
- 検証が必要

**可能性2: GEVP解決に問題がある**
- 固有値の順序が逆？
- 高λ vs 低λの解釈が間違っている？

**可能性3: Safety Subspaceの選択が間違っている**
- 現在: 高λの固有ベクトルを選択
- 正しい？: 低λの固有ベクトルを選択すべき？

---

## 理論の再確認

### GEVP理論

```
F_safety v = λ F_utility v

λ = (v^T F_safety v) / (v^T F_utility v)
```

**固有値λの意味**:
- **λ大**: v方向はSafety重要、Utility非重要 → **Safety追加に適している**
- **λ小**: v方向はSafety非重要、Utility重要 → **Utility維持に適している**

**Safety Subspace**:
- **高λの固有ベクトル**: Safetyを追加してもUtilityに影響しない方向
- **期待**: Utility維持、Safety向上

**現実**:
- Jailbreak: 78.2% ✅（Safety向上）
- RepliQA: 34.1% ❌（Utility破壊）

**矛盾**: 理論通りならUtilityは維持されるはずだが、実際は破壊されている

---

## 次のアクション

### 優先度1: 実装の検証

```bash
# GEVPの固有値を確認
grep "eigenvalue" /tmp/sst_merge_*.log

# 期待:
# Top eigenvalue: 大きい値（例: 6121.356445）
# Bottom eigenvalue: 小さい値（例: 3549.708252）
```

### 優先度2: 元のSST-Mergeコードと比較

```bash
# 元のsst_merge.pyの実装を確認
diff sst_merge_v2/src/sst_merge_v2.py src/sst_merge.py
```

### 優先度3: k=30, 50で継続

**仮説**: k↑ → Utility改善の可能性
- k=30: Jailbreak 80%+, MMLU 51%+, RepliQA 35%+？
- k=50: Jailbreak 85%+, MMLU 52%+, RepliQA 37%+？

---

## 暫定結論

### ✅ 達成したこと

1. **Jailbreak目標達成**: 78.20% > 77%
2. **k値の影響確認**: k↑ → Jailbreak↑

### ❌ 未達成

1. **MMLU**: 50.60% < 52%（-1.4%）
2. **RepliQA**: 34.10% < 40%（-5.9%）

### 🔍 調査が必要

1. **RepliQAが改善しない理由**
2. **元のSST-Mergeとの実装差分**
3. **射影の正しさ**

---

## 推奨事項

### 短期（継続実行）

```bash
# k=30, 50, 70, 100, 150, 200を継続実行
# 期待: k↑でUtility改善の可能性
```

### 中期（実装検証）

1. 元のSST-Mergeコードと詳細比較
2. GEVPの固有値・固有ベクトルを確認
3. 射影の実装を検証

### 長期（代替アプローチ）

1. **レイヤー別k設定**: 出力層は高k、FFNは低k
2. **Safety Weight調整**: safety_weight < 1.0でUtility維持
3. **ハイブリッド戦略**: MergekitとSST-Mergeの組み合わせ

---

## 期待される最終結果

| k値 | Jailbreak | MMLU | RepliQA | 評価 |
|-----|-----------|------|---------|------|
| 10 | 74.8% | 49.6% | 34.0% | ❌ 全て未達 |
| 20 | 78.2% | 50.6% | 34.1% | △ Jailbreakのみ達成 |
| 30 | 80-82% | 51-52% | 35-37% | ? |
| 50 | 85-87% | 52-53% | 37-39% | ? |
| 100 | 90-92% | 50-52% | 35-38% | ? |
| 200 | 95-97% | 48-50% | 30-35% | ? |

**目標**: k=50-100でJailbreak 85%+, MMLU 52%+, RepliQA 38%+を達成
