# SST-Merge 包括的比較分析レポート

## 実行サマリー

### 元のSST-Merge
- **実行期間**: 2025年12月
- **パラメータ範囲**: k=3-100, α=0.5-10.0, samples=500-1000
- **評価済み設定**: 4つ（A5+A7のみ）

### SST-Merge V2
- **実行期間**: 2026年1月
- **パラメータ範囲**: k=10-200, w=1.0, samples=500
- **評価済み設定**: 8つ

---

## 全結果一覧

### 元のSST-Merge（A5+A7）

| k  | α   | samples | Jailbreak | MMLU | RepliQA | 評価 |
|----|-----|---------|-----------|------|---------|------|
| 3  | 1.0 | ?       | 75.8%     | 52.3% | **40.5%** | ほぼ達成 |
| 5  | 0.5 | ?       | 57.4%     | 55.9% | 0.0%*   | データ不足 |
| 10 | 0.8 | ?       | 70.6%     | 54.0% | 32.4%   | RepliQA低い |
| **20** | **1.0** | **?** | **77.6%** ✓ | **52.9%** ✓ | **40.5%** ✓ | **全目標達成** ✅ |

*RepliQA 0.0%はデータ欠損と推測

### SST-Merge V2（A5+A7）

| k   | w   | samples | Jailbreak | MMLU | RepliQA | Alpaca | 評価 |
|-----|-----|---------|-----------|------|---------|--------|------|
| 10  | 1.0 | 500     | 74.8%     | 49.6% | 34.0%  | 35.9%  | 全て未達 |
| **20** | **1.0** | **500** | **78.2%** ✓ | **50.6%** | **34.1%** | 34.8%  | Jailbreakのみ |
| 30  | 1.0 | 500     | 78.2% ✓   | 49.6% | 33.1%  | 35.0%  | Jailbreakのみ |
| 50  | 1.0 | 500     | 76.6%     | 50.0% | 32.8%  | 34.8%  | 全て未達 |
| 70  | 1.0 | 500     | 76.6%     | 49.0% | 32.8%  | 35.2%  | 全て未達 |
| 100 | 1.0 | 500     | 77.4% ✓   | 50.0% | 32.9%  | 34.9%  | Jailbreakのみ |
| 150 | 1.0 | 500     | 77.4% ✓   | 50.6% | 33.0%  | 34.7%  | Jailbreakのみ |
| 200 | 1.0 | 500     | 73.6%     | 50.6% | 34.0%  | 35.0%  | 全て未達 |

---

## 詳細比較分析

### 1. 同一設定での比較（k=20, α/w=1.0）

| メトリクス | 元のSST | V2 | 差分 | 評価 |
|-----------|---------|-----|------|------|
| Jailbreak | 77.6% | 78.2% | **+0.6%** | ✅ V2がわずかに良い |
| MMLU | 52.9% | 50.6% | **-2.3%** | ❌ V2が悪化 |
| RepliQA | 40.5% | 34.1% | **-6.4%** | ❌ V2が大幅悪化 |

**結論**: 
- **同じ設定でV2が悪化**
- Jailbreakはわずかに改善
- **Utilityが大幅に低下**

---

### 2. kパラメータの影響

#### 元のSST-Merge

| k | Jailbreak | MMLU | RepliQA | 傾向 |
|---|-----------|------|---------|------|
| 3 | 75.8% | 52.3% | 40.5% | - |
| 10 | 70.6% | 54.0% | 32.4% | k↑でRepliQA↓ |
| 20 | 77.6% | 52.9% | 40.5% | 最良 |

**傾向**:
- k=20が最良
- k=10でRepliQA大幅低下（32.4%）
- **k↑でRepliQA改善するとは限らない**

#### SST-Merge V2

| k | Jailbreak | MMLU | RepliQA | 傾向 |
|---|-----------|------|---------|------|
| 10 | 74.8% | 49.6% | 34.0% | - |
| 20 | 78.2% | 50.6% | 34.1% | ピーク |
| 30 | 78.2% | 49.6% | 33.1% | 横ばい |
| 50 | 76.6% | 50.0% | 32.8% | 低下 |
| 100 | 77.4% | 50.0% | 32.9% | 回復 |
| 200 | 73.6% | 50.6% | 34.0% | 低下 |

**傾向**:
- k=20-30が最良
- k↑でJailbreak悪化
- **RepliQAはほぼ横ばい（32-34%）**

---

### 3. α（safety_weight）の影響

#### 元のSST-Merge

| k | α | Jailbreak | MMLU | RepliQA | 評価 |
|---|---|-----------|------|---------|------|
| 5 | 0.5 | 57.4% | 55.9% | 0.0%* | α低すぎ |
| 10 | 0.8 | 70.6% | 54.0% | 32.4% | α適切 |
| 3 | 1.0 | 75.8% | 52.3% | 40.5% | α適切 |
| 20 | 1.0 | 77.6% | 52.9% | 40.5% | α適切 |

**傾向**:
- α=0.5: Jailbreak低すぎ（57.4%）
- α=0.8-1.0: バランス良好
- **α=1.0が最良**

#### SST-Merge V2

| k | w | Jailbreak | MMLU | RepliQA | 評価 |
|---|---|-----------|------|---------|------|
| 全て | 1.0 | 73.6-78.2% | 49.0-50.6% | 32.8-34.1% | 固定 |

**傾向**:
- w=1.0のみテスト済み
- **wの影響は未検証**

---

### 4. サンプル数の影響

#### 元のSST-Merge

利用可能なデータ:
- s500: 複数の設定
- s1000: k=20, k=30, k=100（α=1.0, 10.0）

**注**: aggregated_results.jsonにはサンプル数情報なし

#### SST-Merge V2

- s500のみ（全設定）

**結論**: サンプル数の影響は不明（元のSST-Mergeのデータ不足）

---

## 重要な発見

### 1. 元のSST-Mergeは目標達成していた

**k=20, α=1.0**:
- Jailbreak: 77.6% ✓
- MMLU: 52.9% ✓
- RepliQA: 40.5% ✓
- **全目標達成** ✅

### 2. V2は同じ設定で悪化

**k=20, w=1.0**:
- Jailbreak: 78.2% ✓ (+0.6%)
- MMLU: 50.6% ✗ (-2.3%)
- RepliQA: 34.1% ✗ (-6.4%)
- **Utilityが大幅低下** ❌

### 3. RepliQAの一貫した低下

**元のSST-Merge**:
- k=3, α=1.0: 40.5%
- k=10, α=0.8: 32.4%
- k=20, α=1.0: 40.5%

**V2**:
- 全k値: 32.8-34.1%

**傾向**:
- **V2は一貫してRepliQA 32-34%**
- 元のSST-Mergeでもk=10で32.4%
- **k=20, α=1.0の組み合わせが重要**

### 4. k↑の効果なし

**期待**: k↑ → Jailbreak↑, Utility維持

**現実（V2）**:
- k=20: Jailbreak 78.2%
- k=200: Jailbreak 73.6% ↓
- RepliQA: ほぼ横ばい（32-34%）

**結論**: **k↑の効果なし、むしろ悪化**

---

## 根本原因の特定

### 仮説1: 実装差分

**証拠**:
- 同じ設定（k=20, α/w=1.0）で結果が異なる
- V2でUtilityが大幅低下

**可能性**:
1. FIM計算の違い
2. 射影の実装の違い
3. マージの実装の違い
4. Safety Subspace選択の違い

### 仮説2: サンプル数不足

**証拠**:
- V2: s=500のみ
- 元のSST-Merge: s=500, 1000

**可能性**:
- s=500では FIM精度不足
- s=1000でRepliQA改善の可能性

### 仮説3: αの最適値が1.0ではない

**証拠**:
- 元のSST-Merge: α=0.8でRepliQA 32.4%
- 元のSST-Merge: α=1.0でRepliQA 40.5%

**可能性**:
- V2でw=1.0は強すぎる
- w=0.7-0.9が最適の可能性

---

## 修正計画の更新

### Phase 1: 実装差分の特定（最優先）

**目的**: 元のSST-Mergeと V2の実装差分を特定

**実行**:
```bash
# 1. 元のSST-Mergeのコードを確認
cat src/sst_merge.py | grep -A 100 "def merge_utility_safety"

# 2. V2のコードと比較
cat sst_merge_v2/src/sst_merge_v2.py | grep -A 100 "def merge_utility_safety"

# 3. 差分を確認
diff -u src/sst_merge.py sst_merge_v2/src/sst_merge_v2.py
```

---

### Phase 2: 元のSST-Mergeの再実行（検証）

**目的**: 元のSST-Mergeでk=20, α=1.0の結果を再現

**実行**:
```bash
# 元のSST-Mergeを実行
cd /mnt/iag-02/home/hiromi/src/SST_merge
python src/sst_merge.py \
    --model llama-3.1-8b \
    --variant A5+A7 \
    --k 20 \
    --alpha 1.0 \
    --max_samples 500

# 評価
python experiments/evaluate_instruction_models.py \
    --adapter saved_adapters/llama-3.1-8b/sst_merged/sst_merged_A5_A7_k20_alpha1.0_s500_NEW.pt \
    --model llama-3.1-8b
```

**期待**: Jailbreak 77.6%, MMLU 52.9%, RepliQA 40.5%

---

### Phase 3: サンプル数の増加

**目的**: s=1000でFIM精度向上

**実行**:
```bash
# V2でs=1000を試す
python scripts/run_merge.py \
    --model llama-3.1-8b \
    --variant A5+A7 \
    --k 20 \
    --safety_weight 1.0 \
    --max_samples 1000 \
    --use_fim

python scripts/evaluate.py \
    --adapter results/llama-3.1-8b/sst_v2_A5_A7_*_k20_*_s1000_*.pt \
    --model llama-3.1-8b \
    --max_samples 500
```

**期待**: RepliQA 37-40%

---

### Phase 4: αの最適化

**目的**: w=0.7-0.9でUtility改善

**実行**:
```bash
for w in 0.7 0.8 0.9; do
    python scripts/run_merge.py \
        --model llama-3.1-8b \
        --variant A5+A7 \
        --k 20 \
        --safety_weight $w \
        --max_samples 500 \
        --use_fim
    
    python scripts/evaluate.py \
        --adapter results/llama-3.1-8b/sst_v2_A5_A7_*_k20_*_w${w}_*.pt \
        --model llama-3.1-8b \
        --max_samples 500
done
```

**期待**: w=0.8-0.9でRepliQA 37-40%

---

## 推奨される実行順序

1. **Phase 1: 実装差分の特定**（今すぐ、10-20分）
2. **Phase 2: 元のSST-Merge再実行**（検証、1-2時間）
3. **Phase 3: サンプル数増加**（s=1000、1-2時間）
4. **Phase 4: α最適化**（w=0.7-0.9、3-4時間）

---

## 期待される結果

### Phase 2完了後（元のSST-Merge再現）

| メトリクス | 元の結果 | 再現 | 差分 |
|-----------|---------|------|------|
| Jailbreak | 77.6% | 77-78% | 0-0.4% |
| MMLU | 52.9% | 52-53% | 0-0.4% |
| RepliQA | 40.5% | 40-41% | 0-0.5% |

### Phase 3完了後（s=1000）

| メトリクス | s=500 | s=1000 | 改善 |
|-----------|-------|--------|------|
| Jailbreak | 78.2% | 77-78% | -0.2~0% |
| MMLU | 50.6% | 51-52% | +0.4~1.4% |
| RepliQA | 34.1% | 37-40% | +2.9~5.9% |

### Phase 4完了後（w=0.7-0.9）

| メトリクス | w=1.0 | w=0.8 | 改善 |
|-----------|-------|-------|------|
| Jailbreak | 78.2% | 75-77% | -1.2~-3.2% |
| MMLU | 50.6% | 52-53% | +1.4~2.4% |
| RepliQA | 34.1% | 38-40% | +3.9~5.9% |

---

## まとめ

### 重要な発見

1. **元のSST-Mergeは目標達成**（k=20, α=1.0）
2. **V2は同じ設定で悪化**（特にRepliQA -6.4%）
3. **k↑の効果なし**（むしろ悪化）
4. **α=1.0が最良**（元のSST-Mergeの結果）

### 根本原因

1. **実装差分**（最も可能性が高い）
2. **サンプル数不足**（s=500では不十分の可能性）
3. **α最適化**（w=0.8-0.9が最適の可能性）

### 次のアクション

**今すぐ実行**:
```bash
# 実装差分を確認
diff -u src/sst_merge.py sst_merge_v2/src/sst_merge_v2.py | head -300
```

**その後**:
1. 元のSST-Merge再実行（検証）
2. サンプル数増加（s=1000）
3. α最適化（w=0.7-0.9）
