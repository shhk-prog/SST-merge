# SST-Merge V2 ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒçµæœ å®Œå…¨åˆ†æ

## å®Ÿè¡Œã‚µãƒãƒªãƒ¼

- **å®Ÿè¡ŒæœŸé–“**: 2026-01-06 02:00 - 12:00 (ç´„10æ™‚é–“)
- **kå€¤**: 10, 20, 30, 50, 70, 100, 150, 200
- **è©•ä¾¡ã‚µãƒ³ãƒ—ãƒ«æ•°**: å„500ã‚µãƒ³ãƒ—ãƒ«
- **è©•ä¾¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: Jailbreak, MMLU, RepliQA, Alpaca, Beavertails

---

## å…¨çµæœä¸€è¦§

| k   | Jailbreak | MMLU  | RepliQA | Alpaca | Refusal | Harmful |
|-----|-----------|-------|---------|--------|---------|---------|
| 10  | 74.8%     | 49.6% | 34.0%   | 35.9%  | 3.0%    | 0.8%    |
| 20  | **78.2%** | **50.6%** | **34.1%** | 34.8%  | 2.2%    | 0.8%    |
| 30  | 78.2%     | 49.6% | 33.1%   | 35.0%  | 2.6%    | 0.8%    |
| 50  | 76.6%     | 50.0% | 32.8%   | 34.8%  | 1.8%    | 1.0%    |
| 70  | 76.6%     | 49.0% | 32.8%   | 35.2%  | 2.4%    | 1.4%    |
| 100 | 77.4%     | 50.0% | 32.9%   | 34.9%  | 2.0%    | 0.4%    |
| 150 | 77.4%     | 50.6% | 33.0%   | 34.7%  | 1.8%    | 0.6%    |
| 200 | 73.6%     | 50.6% | 34.0%   | 35.0%  | 2.6%    | 1.4%    |

---

## ç›®æ¨™é”æˆçŠ¶æ³

**ç›®æ¨™**: Jailbreak 77%+, MMLU 52%+, RepliQA 40%+

| k   | Jailbreak | MMLU | RepliQA | Overall |
|-----|-----------|------|---------|---------|
| 10  | âœ— (74.8%) | âœ— (49.6%) | âœ— (34.0%) | âŒ |
| 20  | âœ“ (78.2%) | âœ— (50.6%) | âœ— (34.1%) | âŒ |
| 30  | âœ“ (78.2%) | âœ— (49.6%) | âœ— (33.1%) | âŒ |
| 50  | âœ— (76.6%) | âœ— (50.0%) | âœ— (32.8%) | âŒ |
| 70  | âœ— (76.6%) | âœ— (49.0%) | âœ— (32.8%) | âŒ |
| 100 | âœ“ (77.4%) | âœ— (50.0%) | âœ— (32.9%) | âŒ |
| 150 | âœ“ (77.4%) | âœ— (50.6%) | âœ— (33.0%) | âŒ |
| 200 | âœ— (73.6%) | âœ— (50.6%) | âœ— (34.0%) | âŒ |

**çµè«–**: **å…¨ã¦ã®kå€¤ã§ç›®æ¨™æœªé”æˆ**

---

## é‡è¦ãªç™ºè¦‹

### 1. k=20ãŒæœ€è‰¯

**å…¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§k=20ãŒæœ€é«˜**:
- Jailbreak: 78.2% (æœ€é«˜)
- MMLU: 50.6% (æœ€é«˜ã‚¿ã‚¤)
- RepliQA: 34.1% (æœ€é«˜)

**kâ†‘ã®åŠ¹æœãªã—**:
- k=30-200ã§Jailbreakã€MMLUã€RepliQAãŒ**æ‚ªåŒ–ã¾ãŸã¯æ¨ªã°ã„**
- æœŸå¾…: kâ†‘ â†’ Jailbreakâ†‘
- ç¾å®Ÿ: kâ†‘ â†’ Jailbreakâ†“ or æ¨ªã°ã„

### 2. RepliQAãŒå…¨ãæ”¹å–„ã—ãªã„

**å…¨kå€¤ã§RepliQA 32-34%**:
- ç›®æ¨™: 40%+
- æœ€é«˜: 34.1% (k=20)
- æœ€ä½: 32.8% (k=50, 70)
- **å¤‰å‹•å¹…**: ã‚ãšã‹1.3%

**æ¯”è¼ƒ**:
- A5å˜ä½“: 40.2%
- å…ƒã®SST-Merge: 40.5%
- **ç¾åœ¨**: 32-34%
- **å·®åˆ†**: -6~-8%

### 3. MMLUã‚‚ç›®æ¨™æœªé”

**å…¨kå€¤ã§MMLU 49-51%**:
- ç›®æ¨™: 52%+
- æœ€é«˜: 50.6% (k=20, 150, 200)
- æœ€ä½: 49.0% (k=70)
- **å¤‰å‹•å¹…**: 1.6%

**æ¯”è¼ƒ**:
- A5å˜ä½“: 52.7%
- å…ƒã®SST-Merge: 52.9%
- **ç¾åœ¨**: 49-51%
- **å·®åˆ†**: -2~-4%

### 4. kâ†‘ã§JailbreakãŒæ‚ªåŒ–

**äºˆæƒ³å¤–ã®å‚¾å‘**:
```
k=10: 74.8%
k=20: 78.2% â† ãƒ”ãƒ¼ã‚¯
k=30: 78.2%
k=50: 76.6% â†“
k=70: 76.6%
k=100: 77.4%
k=150: 77.4%
k=200: 73.6% â†“â†“
```

**ç†è«–ã¨ã®çŸ›ç›¾**:
- ç†è«–: kâ†‘ â†’ Safetyæƒ…å ±â†‘ â†’ Jailbreakâ†‘
- ç¾å®Ÿ: kâ†‘ â†’ Jailbreakâ†“

---

## æ ¹æœ¬åŸå› ã®åˆ†æ

### ä»®èª¬1: å®Ÿè£…ã«æ ¹æœ¬çš„ãªå•é¡ŒãŒã‚ã‚‹

**è¨¼æ‹ **:
1. **RepliQAãŒå…¨ãæ”¹å–„ã—ãªã„** (32-34%)
2. **kâ†‘ã§JailbreakãŒæ‚ªåŒ–** (k=200: 73.6%)
3. **å…ƒã®SST-Mergeã‚ˆã‚Šå¤§å¹…ã«æ‚ªã„**

**å¯èƒ½æ€§**:
- å°„å½±ã®å®Ÿè£…ãŒé–“é•ã£ã¦ã„ã‚‹
- GEVPè§£æ±ºãŒé–“é•ã£ã¦ã„ã‚‹
- Safety Subspaceã®é¸æŠãŒé€†

### ä»®èª¬2: Safety Subspaceã®é¸æŠãŒé€†

**ç¾åœ¨ã®å®Ÿè£…**:
```python
# é«˜Î»ã®å›ºæœ‰ãƒ™ã‚¯ãƒˆãƒ«ã‚’é¸æŠ
safety_subspace = eigenvectors[:, :k]  # ä¸Šä½kå€‹
```

**æ­£ã—ã„å®Ÿè£…ï¼Ÿ**:
```python
# ä½Î»ã®å›ºæœ‰ãƒ™ã‚¯ãƒˆãƒ«ã‚’é¸æŠï¼Ÿ
safety_subspace = eigenvectors[:, -k:]  # ä¸‹ä½kå€‹
```

**ç†è«–ã®å†ç¢ºèªãŒå¿…è¦**:
```
Î» = (v^T F_safety v) / (v^T F_utility v)

é«˜Î»: Safetyé‡è¦ã€Utilityéé‡è¦ â†’ Safetyè¿½åŠ ã«é©ã—ã¦ã„ã‚‹ï¼Ÿ
ä½Î»: Safetyéé‡è¦ã€Utilityé‡è¦ â†’ Utilityç¶­æŒã«é©ã—ã¦ã„ã‚‹ï¼Ÿ
```

### ä»®èª¬3: å°„å½±ãŒéåº¦ã«Utilityã‚’ç ´å£Š

**RepliQA 32-34%ã®å•é¡Œ**:
- A5å˜ä½“: 40.2%
- å°„å½±å¾Œ: 32-34%
- **æå¤±**: -6~-8%

**åŸå› **:
- å°„å½±ãŒUtilityã«å¹²æ¸‰ã—ã¦ã„ã‚‹
- Safety SubspaceãŒå®Ÿã¯Utilityç ´å£Šæ–¹å‘

---

## ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ã®æ¯”è¼ƒ

### å…ƒã®SST-Merge (k=20)

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å…ƒã®SST | ç¾åœ¨ (k=20) | å·®åˆ† |
|-----------|---------|-------------|------|
| Jailbreak | 77.6%   | 78.2%       | **+0.6%** âœ… |
| MMLU      | 52.9%   | 50.6%       | **-2.3%** âŒ |
| RepliQA   | 40.5%   | 34.1%       | **-6.4%** âŒ |

**çµè«–**: 
- Safetyã¯ã‚ãšã‹ã«æ”¹å–„
- **UtilityãŒå¤§å¹…ã«æ‚ªåŒ–**

### Mergekitãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | DARE | TIES | Task-Arith | ç¾åœ¨ (k=20) |
|-----------|------|------|------------|-------------|
| Jailbreak | 99.4% | 100% | 99.6%      | 78.2%       |
| MMLU      | 55.6% | 52.0% | 52.5%     | 50.6%       |
| RepliQA   | 16.7% | 15.6% | 16.8%     | 34.1%       |

**çµè«–**:
- Jailbreak: Mergekitã‚ˆã‚Šå¤§å¹…ã«ä½ã„
- RepliQA: Mergekitã‚ˆã‚Šå¤§å¹…ã«é«˜ã„ï¼ˆè‰¯ã„ï¼‰
- **ä¸­é€”åŠç«¯ãªæ€§èƒ½**

---

## æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å„ªå…ˆåº¦1: å®Ÿè£…ã®å¾¹åº•æ¤œè¨¼

```bash
# 1. å…ƒã®SST-Mergeã‚³ãƒ¼ãƒ‰ã¨è©³ç´°æ¯”è¼ƒ
diff -u src/sst_merge.py sst_merge_v2/src/sst_merge_v2.py

# 2. GEVPè§£æ±ºã®ç¢ºèª
# - å›ºæœ‰å€¤ã®é †åº
# - å›ºæœ‰ãƒ™ã‚¯ãƒˆãƒ«ã®é¸æŠæ–¹å‘

# 3. å°„å½±ã®ç¢ºèª
# - å…¬å¼: P = V_k @ V_k^T
# - å®Ÿè£…: _project_param
```

### å„ªå…ˆåº¦2: Safety Subspaceé¸æŠã‚’é€†è»¢

```python
# ç¾åœ¨
safety_subspace = eigenvectors[:, :k]  # ä¸Šä½kå€‹ï¼ˆé«˜Î»ï¼‰

# è©¦ã™
safety_subspace = eigenvectors[:, -k:]  # ä¸‹ä½kå€‹ï¼ˆä½Î»ï¼‰
```

### å„ªå…ˆåº¦3: ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

#### A. ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥kè¨­å®š

```python
layer_k_config = {
    'lm_head': 200,      # å‡ºåŠ›å±¤: é«˜k
    'q_proj': 50,        # Attention: ä¸­k
    'v_proj': 50,
    'k_proj': 50,
    'o_proj': 50,
    'gate_proj': 10,     # FFN: ä½k
    'up_proj': 10,
    'down_proj': 10,
}
```

#### B. Safety Weightèª¿æ•´

```python
# ç¾åœ¨: safety_weight = 1.0
# è©¦ã™: safety_weight = 0.5, 0.7, 1.5, 2.0
```

#### C. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æˆ¦ç•¥

```
å‡ºåŠ›å±¤: Mergekit DARE (é«˜Jailbreak)
FFN: SST-Merge (é«˜Utility)
```

---

## çµè«–

### âŒ ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒã®çµæœ

1. **å…¨kå€¤ã§ç›®æ¨™æœªé”æˆ**
2. **k=20ãŒæœ€è‰¯** (Jailbreak 78.2%, MMLU 50.6%, RepliQA 34.1%)
3. **kâ†‘ã®åŠ¹æœãªã—** (ã‚€ã—ã‚æ‚ªåŒ–)

### ğŸ” æ ¹æœ¬åŸå› 

1. **RepliQAãŒæ”¹å–„ã—ãªã„** â†’ å°„å½±ãŒUtilityã‚’ç ´å£Š
2. **kâ†‘ã§Jailbreakæ‚ªåŒ–** â†’ ç†è«–ã¨ã®çŸ›ç›¾
3. **å…ƒã®SST-Mergeã‚ˆã‚Šæ‚ªã„** â†’ å®Ÿè£…ã«å•é¡Œã®å¯èƒ½æ€§

### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **å®Ÿè£…æ¤œè¨¼**: å…ƒã®SST-Mergeã¨è©³ç´°æ¯”è¼ƒ
2. **Safety Subspaceé€†è»¢**: ä½Î»ã®å›ºæœ‰ãƒ™ã‚¯ãƒˆãƒ«ã‚’è©¦ã™
3. **ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥kã€Safety Weightèª¿æ•´ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æˆ¦ç•¥

---

## æœ€çµ‚æ¨å¥¨

**ç¾æ™‚ç‚¹ã§ã®æœ€è‰¯è¨­å®š**: k=20
- Jailbreak: 78.2% (ç›®æ¨™é”æˆ)
- MMLU: 50.6% (ç›®æ¨™æœªé”: -1.4%)
- RepliQA: 34.1% (ç›®æ¨™æœªé”: -5.9%)

**ã—ã‹ã—ã€å®Ÿè£…ã®æ ¹æœ¬çš„ãªè¦‹ç›´ã—ãŒå¿…è¦**
